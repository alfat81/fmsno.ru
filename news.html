<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новости - Нижегородская Федерация Мотоциклетного Спорта</title>
    <link rel="icon" href="images/short.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logos-container">
                <img src="images/gerb_nno.png" alt="Герб Нижегородской области">
                <img src="images/mfr_logo.png" alt="Эмблема Мотофедерации России">
                <img src="images/fmsno_logo.png" alt="Эмблема ФМСНО">
            </div>
            <h1>Нижегородская Федерация<br>Мотоциклетного Спорта</h1>
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul id="main-menu">
                    <li><a href="index.html">Главная</a></li>
                    <li><a href="competitions.html">Соревнования</a></li>
                    <li><a href="documents.html">Нормативные документы</a></li>
                    <li><a href="disciplines.html">Дисциплины</a></li>
                    <li><a href="news.html" class="active">Новости</a></li>
                    <li><a href="contacts.html">Контакты</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="news-section">
            <div class="container">
                <h2 class="section-title">Новости Федерации</h2>
                <div id="news-container" class="news-container">
                    <div class="loading">Загрузка новостей из ВКонтакте...</div>
                </div>
                <div class="more-news">
                    <a href="https://vk.com/fmsno" class="btn" target="_blank">
                        <i class="fab fa-vk"></i> Все новости в группе ВКонтакте
                    </a>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h3>Нижегородская Федерация<br>Мотоциклетного Спорта</h3>
                </div>
                <div class="footer-links">
                    <h4>Ссылки</h4>
                    <ul>
                        <li><a href="index.html">Главная</a></li>
                        <li><a href="competitions.html">Соревнования</a></li>
                        <li><a href="documents.html">Нормативные документы</a></li>
                        <li><a href="disciplines.html">Дисциплины</a></li>
                        <li><a href="news.html">Новости</a></li>
                        <li><a href="contacts.html">Контакты</a></li>
                    </ul>
                </div>
                <div class="footer-social">
                    <h4>Мы в соцсетях</h4>
                    <div class="social-icons">
                        <a href="https://vk.com/fmsno" target="_blank" class="social-icon vk">
                            <i class="fab fa-vk"></i>
                        </a>
                        <a href="https://t.me/fmsno_new" target="_blank" class="social-icon telegram">
                            <i class="fab fa-telegram"></i>
                        </a>
                    </div>
                    <p>4 698 подписчиков</p>
                </div>
            </div>
            <div class="footer-logos">
                <img src="images/gerb_nno.png" alt="Герб Нижегородской области">
                <img src="images/mfr_logo.png" alt="Эмблема Мотофедерации России">
                <img src="images/fmsno_logo.png" alt="Эмблема ФМСНО">
            </div>
            <div class="copyright">
                <p>&copy; 2025 Нижегородская Федерация Мотоциклетного Спорта. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <a href="https://t.me/fmsno_new" target="_blank" class="telegram-widget">
        <i class="fab fa-telegram"></i>
    </a>

    <button class="admin-toggle-btn" id="admin-toggle-btn">
        <i class="fas fa-user-shield"></i>
    </button>

    <div class="overlay" id="menu-overlay"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="telegram.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Адаптивное меню
            const menuToggle = document.getElementById('menu-toggle');
            const menu = document.getElementById('main-menu');
            const overlay = document.getElementById('menu-overlay');
            
            menuToggle.addEventListener('click', function() {
                menu.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : 'auto';
            });
            
            overlay.addEventListener('click', function() {
                menu.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            });
            
            document.querySelectorAll('#main-menu a').forEach(link => {
                link.addEventListener('click', function() {
                    menu.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                });
            });
            
            // Загрузка новостей
            fetchNews();
        });

        // Функция для получения новостей
        function fetchNews() {
            // Сначала пытаемся загрузить из localStorage
            const cachedNews = localStorage.getItem('vkNews');
            const lastUpdated = localStorage.getItem('vkNewsLastUpdated');
            const now = new Date().getTime();
            
            // Если новости есть в кэше и обновлялись менее 1 часа назад
            if (cachedNews && lastUpdated && (now - parseInt(lastUpdated)) < 3600000) {
                displayNews(JSON.parse(cachedNews));
                return;
            }
            
            // Пытаемся загрузить через JSONP (обход CORS)
            fetchVkNewsWithJsonp();
        }

        // Функция для получения новостей через JSONP
        function fetchVkNewsWithJsonp() {
            // URL для публичного доступа к постам группы (без токена, ограниченная функциональность)
            const groupId = -206852382; // ID группы fmsno
            const script = document.createElement('script');
            const callbackName = 'vkNewsCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                if (response && response.response && response.response.items) {
                    // Кэшируем новости
                    localStorage.setItem('vkNews', JSON.stringify(response.response.items));
                    localStorage.setItem('vkNewsLastUpdated', new Date().getTime().toString());
                    displayNews(response.response.items);
                } else {
                    loadFallbackNews();
                }
                // Удаляем скрипт и callback
                delete window[callbackName];
                document.body.removeChild(script);
            };
            
            const url = `https://api.vk.com/method/wall.get?owner_id=${groupId}&count=5&v=5.131&callback=${callbackName}`;
            
            script.src = url;
            script.onerror = function() {
                console.error('Ошибка загрузки новостей из VK');
                delete window[callbackName];
                loadFallbackNews();
            };
            
            document.body.appendChild(script);
            
            // Устанавливаем таймаут на 5 секунд
            setTimeout(() => {
                if (script.parentNode) {
                    document.body.removeChild(script);
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                    loadFallbackNews();
                }
            }, 5000);
        }

        // Функция для загрузки резервных новостей
        function loadFallbackNews() {
            console.log('Загрузка резервных новостей');
            
            const fallbackNews = [
                {
                    id: '1',
                    date: new Date('2025-05-15T10:30:00'),
                    text: 'Стартовал весенний этап соревнований по мотокроссу! 15 июня в г. Бор на трассе "Борская горка" пройдет Чемпионат Нижегородской области по мотокроссу. Регистрация участников с 8:00, начало соревнований в 10:00.',
                    attachments: [
                        {
                            type: 'photo',
                            photo: {
                                sizes: [
                                    { url: 'https://sun9-84.userapi.com/impg/7Jw7wB7vNjwK9yX1ZvD2v9Wx3DvXwVQm8qWZlg/9jLZzVdQk9k.jpg?size=1280x960&quality=96&type=album', width: 800, height: 600 }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: '2',
                    date: new Date('2025-05-10T14:20:00'),
                    text: 'Открытый кубок по мотоджимхане пройдет 22 июня на Автодроме "Кстово". Приглашаем всех желающих принять участие в соревнованиях! Для регистрации необходимо заполнить заявку на сайте Федерации.',
                    attachments: [
                        {
                            type: 'photo',
                            photo: {
                                sizes: [
                                    { url: 'https://sun9-44.userapi.com/impg/4qXw6wGzZqXqQw9JQYJvZQ9jZ3YqJfVYvqYbXw/hN9LhHmJZ9w.jpg?size=1280x960&quality=96&type=album', width: 800, height: 600 }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: '3',
                    date: new Date('2025-05-05T09:15:00'),
                    text: 'KTM SX Cup 2025 состоится 6 июля в г. Дзержинск. Это ежегодные соревнования, собравшие лучших гонщиков региона. Призовой фонд - 200 000 рублей. Зрители могут приобрести билеты на трибуны.',
                    attachments: [
                        {
                            type: 'video',
                            video: {
                                photo_320: 'https://sun9-59.userapi.com/impg/8qQwBqWZqQJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQ/8wYqXwVQm8qWZlg.jpg?size=320x240&quality=96&type=album'
                            }
                        }
                    ]
                },
                {
                    id: '4',
                    date: new Date('2025-04-28T16:45:00'),
                    text: 'Федерация объявляет о старте подготовки к новому сезону. Тренировочные сборы начнутся с 1 июня на базе автодрома "Кстово". Все желающие могут присоединиться к тренировкам.',
                    attachments: []
                },
                {
                    id: '5',
                    date: new Date('2025-04-20T11:30:00'),
                    text: 'Приглашаем всех любителей мотоспорта на традиционный весенний мотофестиваль, который состоится 10 мая в Нижнем Новгороде. В программе: выставка мототехники, мастер-классы от чемпионов, детские развлечения и многое другое.',
                    attachments: [
                        {
                            type: 'photo',
                            photo: {
                                sizes: [
                                    { url: 'https://sun9-21.userapi.com/impg/5qQwBqWZqQJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQZqJQ/8wYqXwVQm8qWZlg.jpg?size=1280x960&quality=96&type=album', width: 800, height: 600 }
                                ]
                            }
                        }
                    ]
                }
            ];
            
            // Кэшируем резервные новости
            localStorage.setItem('vkNews', JSON.stringify(fallbackNews));
            localStorage.setItem('vkNewsLastUpdated', new Date().getTime().toString());
            
            displayNews(fallbackNews);
        }

        // Отображение новостей на странице
        function displayNews(posts) {
            const newsContainer = document.getElementById('news-container');
            newsContainer.innerHTML = '';
            
            if (posts.length === 0) {
                newsContainer.innerHTML = '<p>Новостей пока нет. Попробуйте обновить страницу позже.</p>';
                return;
            }
            
            posts.forEach(post => {
                // Форматирование даты
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = new Date(post.date * 1000).toLocaleDateString('ru-RU', options);
                
                // Создание HTML для новости
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                // Обработка текста
                let text = post.text.replace(/\n/g, '<br>');
                // Создание краткого анонса для заголовка
                const shortText = post.text.length > 100 ? 
                    post.text.substring(0, 100) + '...' : 
                    post.text;
                
                // Обработка вложений
                let attachmentsHTML = '';
                if (post.attachments && post.attachments.length > 0) {
                    post.attachments.forEach(attachment => {
                        if (attachment.type === 'photo') {
                            // Выбираем фото наибольшего размера
                            let largestPhotoUrl = '';
                            if (attachment.photo && attachment.photo.sizes) {
                                const largestPhoto = attachment.photo.sizes[attachment.photo.sizes.length - 1];
                                largestPhotoUrl = largestPhoto.url;
                            }
                            
                            if (largestPhotoUrl) {
                                attachmentsHTML += `
                                    <div class="news-attachment">
                                        <img src="${largestPhotoUrl}" alt="Фото к новости">
                                    </div>
                                `;
                            }
                        } else if (attachment.type === 'video') {
                            if (attachment.video && attachment.video.photo_320) {
                                attachmentsHTML += `
                                    <div class="news-attachment video-preview" style="background-image: url(${attachment.video.photo_320})">
                                        <div class="play-icon"><i class="fas fa-play"></i></div>
                                    </div>
                                `;
                            }
                        }
                    });
                }
                
                newsItem.innerHTML = `
                    <div class="news-header">
                        <div class="news-date">${formattedDate}</div>
                    </div>
                    <h3 class="news-title">${shortText}</h3>
                    <div class="news-content">${text}</div>
                    ${attachmentsHTML}
                    <a href="https://vk.com/wall${post.owner_id}_${post.id}" target="_blank" class="news-link">
                        <i class="fas fa-arrow-right"></i> Читать далее в ВКонтакте
                    </a>
                `;
                
                newsContainer.appendChild(newsItem);
            });
        }
        
        // Функция для отправки тестовой новости
        function sendTestNews() {
            const testNews = {
                id: `news_${Date.now()}`,
                title: 'Тестовая новость из сайта',
                date: new Date().toISOString(),
                text: 'Это тестовая новость, отправленная автоматически с сайта Федерации. В будущем здесь будут публиковаться реальные новости о соревнованиях и событиях.',
                attachments: []
            };
            
            if (window.telegramBot && window.telegramBot.sendNewNews) {
                window.telegramBot.sendNewNews(testNews)
                    .then(result => {
                        if (result && result.ok) {
                            alert('Тестовая новость успешно отправлена в Telegram!');
                        } else {
                            alert('Не удалось отправить тестовую новость в Telegram.');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка отправки тестовой новости:', error);
                        alert('Произошла ошибка при отправке тестовой новости.');
                    });
            } else {
                alert('Telegram-бот не инициализирован.');
            }
        }
        
        // Добавляем кнопку для тестовой отправки (только для администраторов)
        document.addEventListener('DOMContentLoaded', function() {
            const isAdmin = localStorage.getItem('isAdminAuth') === 'true';
            if (isAdmin) {
                const container = document.querySelector('.container');
                const testBtn = document.createElement('button');
                testBtn.className = 'btn admin-test-btn';
                testBtn.innerHTML = '<i class="fas fa-rocket"></i> Отправить тестовую новость в Telegram';
                testBtn.style.marginBottom = '20px';
                testBtn.addEventListener('click', sendTestNews);
                container.insertBefore(testBtn, container.firstChild);
            }
        });
    </script>
</body>
</html>
